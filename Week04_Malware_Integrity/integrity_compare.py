import csv
import time
import sys
from pathlib import Path
from typing import Dict
from integrity_baseline import sha256_file
# Reuse the hasher from Section 1

RED = "\033[91m"; GREEN = "\033[92m"; YELLOW = "\033[93m"; RESET = "\033[0m"


def file_size(path):
    return Path(path).stat().st_size if Path(path).exists() else ""


def load_baseline(csv_path: Path) -> Dict[str, str]:
    if not csv_path.exists():
        print(f"Error: Baseline file not found: {csv_path}")
        sys.exit(1)

    baseline = {}
    with csv_path.open(newline="", encoding="utf-8") as f:
        r = csv.DictReader(f)
        required = {"file", "sha256"}
        if not required.issubset(set(r.fieldnames or [])):
            print(f"Error: Baseline CSV missing required columns {required}.")
            sys.exit(1)
        for row in r:
            baseline[row["file"]] = row["sha256"]
    return baseline

def compare_to_baseline(folder: Path, baseline_csv: Path, out_csv: Path) -> None:
    baseline = load_baseline(baseline_csv)

    # Build current view
    current = {}
    if not folder.exists():
        print(f"Error: Target folder not found: {folder}")
        sys.exit(1)

    for p in folder.rglob("*"):
        if p.is_file():
            rel = str(p.relative_to(folder))
            try:
                current[rel] = sha256_file(p)
            except Exception as e:
                print(f"Warning: could not hash {p}: {e}")

    modified = [f for f in current if f in baseline and current[f] != baseline[f]]
    new      = [f for f in current if f not in baseline]
    deleted  = [f for f in baseline if f not in current]

    suspicious = [f for f in modified + new if f.endswith((".exe",".py",".sh"))]
    if suspicious:
        print("\n⚠️ Suspicious executable/script changes detected:")
        for fpath in suspicious:
            print("   ⚠", fpath)

    # Save detailed audit
    out_csv.parent.mkdir(parents=True, exist_ok=True)
    with out_csv.open("w", newline="", encoding="utf-8") as f:
        w = csv.writer(f)
        w.writerow(["file","status","old_hash","new_hash","size_bytes","checked_utc"])
        now = time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())
        for fpath in sorted(modified):
            w.writerow([fpath,"MODIFIED",baseline[fpath],current[fpath],now])
        for fpath in sorted(new):
            w.writerow([fpath,"NEW","",current[fpath],now])
        for fpath in sorted(deleted):
            w.writerow([fpath,"DELETED",baseline[fpath],"",now])

    # Console report
    print("=== Integrity Check Report ===")
    print(f"Folder: {folder.resolve()}")
    print(f"Baseline: {baseline_csv.resolve()}")
    print(f"Modified: {len(modified)}")
    for fpath in modified: print(RED + "  - MODIFIED" + RESET, fpath)
    print(f"New: {len(new)}")
    for fpath in new: print(GREEN + "  + NEW" + RESET, fpath)
    print(f"Deleted: {len(deleted)}")
    for fpath in deleted: print(YELLOW + "  x DELETED" + RESET, fpath)
    print(f"\nAudit CSV: {out_csv.resolve()}")

if __name__ == "__main__":
    # Defaults match Section 1 outputs
    folder = Path(sys.argv[1]) if len(sys.argv) > 1 else Path("sample_folder")
    baseline_csv = Path(sys.argv[2]) if len(sys.argv) > 2 else Path("baseline.csv")
    out_csv = Path(sys.argv[3]) if len(sys.argv) > 3 else Path("change_report.csv")
    compare_to_baseline(folder, baseline_csv, out_csv)
